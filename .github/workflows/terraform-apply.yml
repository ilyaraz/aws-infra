name: Terraform Apply (main)

on:
  push:
    branches:
      - main
    paths:
      - "infra/**"

permissions:
  contents: read
  id-token: write

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      dirs: ${{ steps.changed.outputs.dirs }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed infra directories
        id: changed
        shell: bash
        run: |
          set -euo pipefail
          base_sha="${{ github.event.before }}"
          head_sha="${{ github.sha }}"

          if [ "$base_sha" = "0000000000000000000000000000000000000000" ]; then
            base_sha="$(git rev-parse "$head_sha^")"
          fi

          dirs=$(git diff --name-only "$base_sha" "$head_sha" | awk -F/ '/^infra\// {print $1"/"$2}' | sort -u)
          if [ -z "$dirs" ]; then
            echo "dirs=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          json=$(printf '%s\n' "$dirs" | jq -R -s -c 'split("\n")[:-1]')
          echo "dirs=$json" >> "$GITHUB_OUTPUT"

  apply:
    needs: detect
    if: ${{ needs.detect.outputs.dirs != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        dir: ${{ fromJson(needs.detect.outputs.dirs) }}
    concurrency:
      group: terraform-apply-${{ matrix.dir }}
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_TERRAFORM_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-west-2' }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: ${{ matrix.dir }}
        run: terraform init -input=false

      - name: Terraform Apply
        working-directory: ${{ matrix.dir }}
        run: terraform apply -input=false -auto-approve -lock-timeout=5m
